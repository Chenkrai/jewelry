<%- include('layout.ejs'); %>

    <% if ( user == null || user.role != "client" ) { %>
        <%- include('login.ejs') %> 
    <% }  
    else 
    {  %>  
    
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?libraries=places&key=<%= google_maps_api_key %>" ></script>        
    <input type="hidden" id="user_id" value="<%=user.id %>" ></input> 
    <input type="hidden" id="user_name" value="<%=user.name %>" ></input>
      
    <aside style="position: fixed; overflow-y: auto; bottom: 60px; right: 0; top:0; ">
        <a href="/logout">
            <button type="submit" class="btn btn-primary btn-lg btn-block login-button">Logout</button> 
        </a>
        <hr>
        <form action="/filterMetalItemTable" method="POST">
            <div style="margin: 5px">
                <button type="submit" class="btn btn-warning btn-lg">Filter by metal</button>             
            </div>
            <div style="margin: 5px">
                <select name="filter_metal" class="form-control">
                    <option >Select metal</option>
                <%
                if ( itemData.length != 0 ) {
                    var metals = [ ...new Set ( itemData.map ( item => item.metal) ) ]
                    metals.forEach ( function ( metal ) {
                %>
                    <option value="<%=metal %>"><%=metal %></option>
                <% } )
                } %>
                </select>   
            </div>                     
        </form>
        
        <form action="/filterManufacturerItemTable" method="POST">
            <div style="margin: 5px">
                <button type="submit" class="btn btn-warning btn-lg">Filter by manufacturer</button>             
            </div>
            <div style="margin: 5px">
                <select name="filter_manufacturer" class="form-control">
                    <option >Select manufacturer</option>
                <%
                if ( itemData.length != 0 ) {
                    var manufacturers = [ ...new Set ( itemData.map ( item => item.manufacturer) ) ]
                    manufacturers.forEach ( function ( manufacturer ) {
                %>
                    <option value="<%=manufacturer %>"><%=manufacturer %></option>
                <% } )
                } %>
                </select>   
            </div>                     
        </form>
        
       
        <form action="/filterPriceItemTable" method="POST">
            <div style="margin: 5px">
                <button type="submit" class="btn btn-warning btn-lg" >Filter by price</button> 
            </div>
            <div style="margin: 5px; display: flex; flex-direction: row;">
                <label style="color: white; width: 50px">From</label>
                <input name="price_from" class="form-control"></input>
            </div>    
            <div style="margin: 5px; display: flex; flex-direction: row;">
                <label style="color: white; width: 50px">To</label>
                <input name="price_to" class="form-control"></input>
            </div>           
        </form>
        
        <div style="margin: 5px">
            <button type="submit" class="btn btn-warning btn-lg" onclick="filterThreeParams()" >Filter by 3 parameters</button> 
        </div>
        <div style="margin: 5px">
            <select id="manufacturer" class="form-control">
                <option >Select manufacturer</option>   
                <%
                    if ( itemData.length != 0 ) {
                        var manufacturers = [ ...new Set ( itemData.map ( item => item.manufacturer ) ) ]
                        manufacturers.forEach ( function ( manufacturer ) {
                    %>
                        <option value="<%=manufacturer %>"><%=manufacturer %></option>
                    <% } )
                } %>
            </select>  
            </div> 
        <div style="margin: 5px">           
            <select id="gender" class="form-control">
                <option >Select gender</option> 
                <%
                    if ( itemData.length != 0 ) {
                        var genders = [ ...new Set ( itemData.map ( item => item.gender ) ) ]
                        genders.forEach ( function ( gender ) {
                    %>
                        <option value="<%=gender %>"><%=gender %></option>
                    <% } )
                } %>
            </select>
        </div> 
        <div style="margin: 5px"> 
            <select id="metal" class="form-control">
                <option >Select metal</option> 
                <%
                    if ( itemData.length != 0 ) {
                        var metals = [ ...new Set ( itemData.map ( item => item.metal ) ) ]
                        metals.forEach ( function ( metal ) {
                    %>
                        <option value="<%=metal %>"><%=metal %></option>
                    <% })
                } %>
            </select>
        </div> 
        <div style="margin: 5px">          
            <a href="/clearFilters"> 
                <button type="submit" class="btn btn-warning btn-lg">Clear Filters</button> 
            </a>
        </div> 
        <hr> 
        <button class="btn btn-primary btn-lg button-block login-button" onclick="showOrders(null)">Shopping cart</button>              
    </aside>
        
    <section id="tableSection">         
        <div style="margin: 20px; height: 600px; width: 1000px; overflow: auto">
        <div id="cards-container" class="table-data" border="1" >
                        
            <%
            if ( itemData.length != 0 ) {
                var i=1 %>
                
                <% itemData.forEach ( function ( data ) { %>
            
                    <div class="card">
                    <img id="url_<%=i; %>" src="<%=data.url %>" alt="Avatar" style="width:100%">
                    <div class="container" style="display: flex">
                        <p id="details_<%=i; %>" style="margin: 5px"><b><%=data.details %></b></p> 
                        <p id="type_<%=i; %>" style="margin: 5px"><%=data.type %></p> 
                    </div> 
                    <div class="container" style="display: flex; flex-direction: row; margin: 5px;">
                        <p id="metal_<%=i; %>" style="margin: 5px"><%=data.metal %></p> 
                        <p id="gender_<%=i; %>" style="margin: 5px"><%=data.gender %></p> 
                        <p id="manufacturer_<%=i; %>" style="margin: 5px"><%=data.manufacturer %></p> 
                    </div> 
                    <div class="container" style="display: flex">
                        <h4 id="price_<%=i; %>" style="margin: 5px"><b><%=data.price %> â‚ª</b></h4> 
                        <input type="checkbox" style="margin: 5px" id="order_<%=i; %>">
                    </div> 
                    </div>
                <%  i++ 
                    
                 }) %>
                
            <% } else{ %>
                <p>No Data Found</p>                
            <% } %>
        </div>
        </div>
        <div style="margin: 5px">
          <button class="transform btn btn-warning btn-lg" onclick="order()">Purchase</button>  
        </div>
    </section>

    <div id="dialog" title="Orders" style="display: none;">
        <table id="shopping_cart" border="1" ></table>
    </div> 
    
    <div id="map" style="width: 200px; height: 200px; "></div>

    <video id="video_popup" style="display: none; width: 360px;" id="videoPlayer" controls muted="muted" autoplay> 
        <source src="/video" type="video/mp4">
        Sorry, your browser doesn't support embedded videos." type="video/mp4">
    </video>

    <% } %>

<style type="text/css" media="screen, print">
    #tableSection {
        position: absolute;
        bottom: 80px;
    }
    header {
        display: none;
    }

    #cards-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-evenly;        
    }
    
    .card {
        box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2);
        transition: 0.3s;
        margin: 5px 0;
        width: calc(25% - 15px);
    }

    .card:hover {
        box-shadow: 0 8px 16px 0 rgba(0,0,0,0.2);
    }

    img {
        height: 120px;        
    }

</style>  

<script>
            
        function order() {
            $( ".transform" ).addClass( "transform-active" )
            var ordered = []
            var time = Date.now ()
            $( "input:checked" ).each ( function () {
                const index = $( this )[0].id.split( "order_" )[1]
                ordered.push ( {
                    clientId: $("#user_id")[0].value,
                    orderTime: time,
                    type: $("#type_" + index.toString())[0].textContent,
                    details: $("#details_" + index.toString())[0].textContent,
                    price: $("#price_" + index.toString())[0].textContent.split(" ")[0],
                    metal: $("#metal_" + index.toString())[0].textContent,
                    gender: $("#gender_" + index.toString())[0].textContent,
                    manufacturer: $("#manufacturer_" + index.toString())[0].textContent,
                    url: $("#url_" + index.toString())[0].src,
                } )
            } ) 
            
            const webMethod = "/order"
            
            $.ajax({
                type: "POST",
                url: webMethod,
                data: JSON.stringify ( { 'orderList': ordered } ),
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                success: function ( result ) {
                    $( ".transform" ).removeClass("transform-active");
                    socket.emit( "new order", { order: result, userName: $( "#user_name" )[0].value } )
                },
            } )
        }
       
        function filterThreeParams() {
            const webMethod = "/filterThreeParams"
            
            $.ajax ( {
                type: "POST",
                url: webMethod,
                data: JSON.stringify ( 
                    { 
                        'manufacturer': $("#manufacturer")[0].value, 
                        'gender': $("#gender")[0].value, 
                        'metal': $("#metal")[0].value
                    } ),
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                success: function ( result ) {
                    $("#cards-container").empty()
                    var rows = []
                    for (i=0; i<result.length; i++)
                    {
                        var row = $('<div class="card">')
                        row.append($('<img id="url_' + i + '" src="' + result[i]["url"] + '" alt="Avatar" style="width:100%">'))
                        
                        var container1 = $('<div class="container" style="display: flex">')
                        container1.append($('<p id="details_' + i + '" style="margin: 5px"><b>' + result[i]["details"] + '</b></p>')) 
                        container1.append($('<p id="type_' + i + '" style="margin: 5px">' + result[i]["type"] + '</p>')) 
                        
                        var container2 = $('<div class="container" style="display: flex; flex-direction: row; margin: 5px;">')
                        container2.append($('<p id="metal_' + i + '" style="margin: 5px">' + result[i]["metal"] + '</p>')) 
                        container2.append($('<p id="gender_' + i + '" style="margin: 5px">' + result[i]["gender"] + '</p>')) 
                        container2.append($('<p id="manufacturer_' + i + '" style="margin: 5px">' + result[i]["manufacturer"] + '</p>')) 
                        
                        var container3 = $('<div class="container" style="display: flex">')
                        container3.append($('<h4 id="price_' + i + '" style="margin: 5px"><b>' + result[i]["price"] + ' $</b></h4>')) 
                        container3.append($('<input type="checkbox" style="margin: 5px" id="order_' + i + '">'))                                              
                        
                        row.append(container1)
                        row.append(container2)
                        row.append(container3)

                        rows.push(row);
                    }
                    
                    for ( i = 0; i < rows.length; i = i + 1 ) {
                        $("#cards-container").append( rows[i] )
                    }
                },
            } )
        }
    </script>    